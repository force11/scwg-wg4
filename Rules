#!/usr/bin/env ruby

require 'date'

preprocess do
end

ignore '/meetings/*/*.json'

compile '/meetings/*/agenda.txt' do
  write ext: 'mail'
end

compile '/meetings/*/index.md' do
  filter :pandoc, args: [
    { from: :"markdown+autolink_bare_uris", to: :html5 },
    :section_divs
  ]
  snapshot :summary
  layout '/transcript.html'
  write ext: 'html'
end

compile '/meetings/*/index.md', rep: :vtt do
  write ext: 'vtt'
end

compile '/meetings/*/index.md', rep: :mail do
  #filter :pandoc, from: :markdown, to: :plain
  layout '/transcript.mail'
  write ext: 'mail'
end

passthrough '/meetings/*/*.vtt'

compile '/meetings/*/audio_*.vtt', rep: :html do
  filter :vtt2html
end

compile '/**/*.html' do
  layout '/default.*'
end

# This is an example rule that matches Markdown (.md) files, and filters them
# using the :kramdown filter. It is commented out by default, because kramdown
# is not bundled with Nanoc or Ruby.
#
#compile '/**/*.md' do
#  filter :kramdown
#  layout '/default.*'
#end

route '/**/*.{html,md}' do
  if item.identifier =~ '/**/index.*'
    File.join(File.dirname(item.identifier), 'index.html')
  else
    item.identifier.without_ext + '/index.html'
  end
end

compile '/**/*' do
  write item.identifier.to_s
end

layout '/**/*', :erb
